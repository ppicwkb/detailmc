<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS WKB - Monitoring Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile-optimized styles */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #3b82f6;
            z-index: 50;
            padding: 8px;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .mobile-nav-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }
        
        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .mobile-nav-btn.active {
            background: #3b82f6;
            color: white;
        }
        
        .mobile-nav-btn:not(.active) {
            color: #6b7280;
        }
        
        .mobile-nav-icon {
            font-size: 18px;
            margin-bottom: 2px;
        }
        
        .mobile-content {
            padding-bottom: 80px;
        }
        
        .mobile-card {
            margin: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mobile-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px;
        }
        
        .mobile-stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mobile-table {
            font-size: 12px;
        }
        
        .mobile-table td, .mobile-table th {
            padding: 8px 4px;
        }
        
        /* Touch-friendly buttons */
        button, select, input {
            min-height: 44px;
            font-size: 16px;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Mobile Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-blue-600">CS WKB</h1>
                    <p class="text-xs text-gray-500">Monitoring Inventory</p>
                </div>
                <button onclick="refreshData()" class="p-2 bg-blue-500 text-white rounded-lg">
                    üîÑ
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-grid">
            <button onclick="showPage('dashboard')" class="mobile-nav-btn active" id="mobile-dashboard">
                <span class="mobile-nav-icon">üìä</span>
                <span>Home</span>
            </button>
            <button onclick="showPage('inventory')" class="mobile-nav-btn" id="mobile-inventory">
                <span class="mobile-nav-icon">üì¶</span>
                <span>Stock</span>
            </button>
            <button onclick="showPage('outbound')" class="mobile-nav-btn" id="mobile-outbound">
                <span class="mobile-nav-icon">üì§</span>
                <span>Keluar</span>
            </button>
            <button onclick="showPage('reports')" class="mobile-nav-btn" id="mobile-reports">
                <span class="mobile-nav-icon">üìà</span>
                <span>Report</span>
            </button>
            <button onclick="showPage('search')" class="mobile-nav-btn" id="mobile-search">
                <span class="mobile-nav-icon">üîç</span>
                <span>Cari</span>
            </button>
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex items-center space-x-3">
                <div class="loading w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                <span class="text-gray-700">Memuat data...</span>
            </div>
        </div>
    </div>

    <!-- Item Detail Modal -->
    <div id="itemDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-900">Detail Produk</h2>
                    <button onclick="closeItemModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                </div>
                <div id="itemDetailContent">
                    <!-- Content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Outbound Detail Modal -->
    <div id="outboundDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-900">Detail Outbound</h2>
                    <button onclick="closeOutboundModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                </div>
                <div id="outboundDetailContent">
                    <!-- Content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Outbound History Modal -->
    <div id="outboundHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-900">History Outbound</h2>
                    <button onclick="closeOutboundHistoryModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                </div>
                <div id="outboundHistoryContent">
                    <!-- Content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page-content mobile-content">
        <!-- Stats Grid -->
        <div class="mobile-stat-grid">
            <div class="mobile-stat-card border-l-4 border-blue-500">
                <div class="text-2xl mb-1">üì¶</div>
                <div class="text-lg font-bold text-gray-900" id="totalItems">-</div>
                <div class="text-xs text-gray-500">Total Items</div>
            </div>
            <div class="mobile-stat-card border-l-4 border-green-500">
                <div class="text-2xl mb-1">üè≠</div>
                <div class="text-lg font-bold text-gray-900" id="gimLocation">-</div>
                <div class="text-xs text-gray-500">GIM Items</div>
            </div>
            <div class="mobile-stat-card border-l-4 border-yellow-500">
                <div class="text-2xl mb-1">üì¶</div>
                <div class="text-lg font-bold text-gray-900" id="contLocation">-</div>
                <div class="text-xs text-gray-500">CONT Items</div>
            </div>
            <div class="mobile-stat-card border-l-4 border-orange-500">
                <div class="text-2xl mb-1">üè™</div>
                <div class="text-lg font-bold text-gray-900" id="wkbLocation">-</div>
                <div class="text-xs text-gray-500">WKB Items</div>
            </div>
        </div>

        <!-- Total Weight by Location -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3 text-center">Total KG by Location</h3>
            <div class="grid grid-cols-3 gap-3">
                <div class="bg-green-50 rounded-lg p-3 border-l-4 border-green-400 text-center">
                    <div class="text-xl mb-1">üè≠</div>
                    <div class="text-lg font-bold text-green-600" id="gimTotalWeight">-</div>
                    <div class="text-xs text-gray-500">GIM</div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-3 border-l-4 border-yellow-400 text-center">
                    <div class="text-xl mb-1">üì¶</div>
                    <div class="text-lg font-bold text-yellow-600" id="contTotalWeight">-</div>
                    <div class="text-xs text-gray-500">CONT</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-3 border-l-4 border-orange-400 text-center">
                    <div class="text-xl mb-1">üè™</div>
                    <div class="text-lg font-bold text-orange-600" id="wkbTotalWeight">-</div>
                    <div class="text-xs text-gray-500">WKB</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">‚ö° Quick Actions</h3>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="showPage('inventory')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-3 rounded-lg transition-colors duration-200 text-sm">
                    üì¶ Stock
                </button>
                <button onclick="showPage('search')" class="bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-3 rounded-lg transition-colors duration-200 text-sm">
                    üîç Cari
                </button>
            </div>
        </div>

        <!-- Daily Summary -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">üìä Daily Summary</h3>
            <div id="recentActivity" class="space-y-2">
                <p class="text-gray-500 text-sm">Loading daily data...</p>
            </div>
        </div>

        <!-- System Information -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">üìä System Info</h3>
            <div class="p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-blue-400">
                <div class="flex items-center space-x-3">
                    <div class="text-xl">üïí</div>
                    <div>
                        <p class="font-medium text-gray-900 text-sm">Last Update</p>
                        <p id="lastModified" class="text-xs text-gray-600">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Warehouse Performance -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">üè≠ Warehouse Performance</h3>
            <div id="warehouseLocations" class="grid grid-cols-2 gap-2">
                <p class="text-gray-500 text-sm">Loading warehouse data...</p>
            </div>
        </div>
    </div>

    <!-- Inventory Page -->
    <div id="inventoryPage" class="page-content hidden mobile-content">
        <!-- Header -->
        <div class="bg-white shadow-sm p-4 border-b">
            <h2 class="text-xl font-bold text-gray-900">Data Inventory</h2>
            <p class="text-sm text-gray-600">Detail mc</p>
        </div>

        <!-- Filters -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">Filter & Cari</h3>
            <div class="space-y-3">
                <input type="text" id="productIdFilter" placeholder="Cari Produk ID..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <select id="locationFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">Semua Lokasi</option>
                    </select>
                    <select id="brandFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">Semua Brand</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="sizeFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">Semua Size</option>
                    </select>
                    <select id="stockFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">Semua Status</option>
                        <option value="available">Ada Stock</option>
                        <option value="empty">Habis</option>
                        <option value="low">Stock Rendah</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="applyFilters()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm">
                         Filter
                    </button>
                    <button onclick="clearFilters()" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm">
                        ‚úñÔ∏è Clear
                    </button>
                </div>
                <div class="text-center text-xs text-gray-600">
                    <span id="filterResultCount">-</span> items
                </div>
            </div>
        </div>

        <!-- Inventory Cards -->
        <div id="inventoryCards">
            <p class="text-center text-gray-500 p-4">Memuat data...</p>
        </div>
    </div>

    <!-- Daily Outbound Page -->
    <div id="outboundPage" class="page-content hidden mobile-content">
        <!-- Header -->
        <div class="bg-white shadow-sm p-4 border-b">
            <h2 class="text-xl font-bold text-gray-900">Daily Outbound</h2>
            <p class="text-sm text-gray-600">Tracking barang keluar harian</p>
        </div>

        <!-- Filters -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">Filter Outbound</h3>
            <div class="space-y-3">
                <select id="dateFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <option value="">Semua Tanggal</option>
                </select>
                <input type="text" id="outboundProductFilter" placeholder="Cari produk..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <button onclick="applyOutboundFilters()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg text-sm">
                    üîç Filter Outbound
                </button>
            </div>
        </div>

        <!-- Summary -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">üìä Summary Outbound</h3>
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-orange-50 p-3 rounded-lg border-l-4 border-orange-500 text-center">
                    <div class="text-lg font-bold text-orange-600" id="todayOutbound">-</div>
                    <div class="text-xs text-gray-500">Hari Ini</div>
                </div>
                <div class="bg-red-50 p-3 rounded-lg border-l-4 border-red-500 text-center">
                    <div class="text-lg font-bold text-red-600" id="monthOutbound">-</div>
                    <div class="text-xs text-gray-500">Bulan Ini</div>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500 text-center">
                    <div class="text-lg font-bold text-purple-600" id="activeOutbound">-</div>
                    <div class="text-xs text-gray-500">Produk Aktif</div>
                </div>
            </div>
        </div>

        <!-- Outbound Table -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">üì§ Data Outbound</h3>
            <div id="outboundTable" class="space-y-2">
                <p class="text-gray-500 text-sm">Memuat data outbound...</p>
            </div>
        </div>
    </div>

    <!-- Reports Page -->
    <div id="reportsPage" class="page-content hidden mobile-content">
        <!-- Header -->
        <div class="bg-white shadow-sm p-4 border-b">
            <h2 class="text-xl font-bold text-gray-900">üìä Reports</h2>
            <p class="text-sm text-gray-600">Laporan dan analisis inventory</p>
        </div>

        <!-- Stock by Location -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3"> Stock by Location</h3>
            <div id="stockByLocation" class="space-y-2">
                <p class="text-gray-500 text-sm">Memuat data...</p>
            </div>
        </div>
        
        <!-- Stock by Brand -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">üè∑Ô∏è Stock by Brand</h3>
            <div id="stockByBrand" class="space-y-2">
                <p class="text-gray-500 text-sm">Memuat data...</p>
            </div>
        </div>
        
        <!-- Size Distribution -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">üìè Size Distribution (Saldo)</h3>
            <div id="sizeDistributionSaldo" class="space-y-2">
                <p class="text-gray-500 text-sm">Memuat data...</p>
            </div>
        </div>
        
        <!-- Size Distribution KG -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">üìè Size Distribution (KG)</h3>
            <div id="sizeDistributionKG" class="space-y-2">
                <p class="text-gray-500 text-sm">Memuat data...</p>
            </div>
        </div>
        
        <!-- Performance Metrics -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">üìä Performance Metrics</h3>
            <div id="performanceMetrics" class="space-y-2">
                <p class="text-gray-500 text-sm">Memuat data...</p>
            </div>
        </div>
    </div>

    <!-- Search Page -->
    <div id="searchPage" class="page-content hidden mobile-content">
        <!-- Header -->
        <div class="bg-white shadow-sm p-4 border-b">
            <h2 class="text-xl font-bold text-gray-900">Search Inventory</h2>
            <p class="text-sm text-gray-600">Cari produk dengan mudah</p>
        </div>

        <!-- Search Form -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">Pencarian</h3>
            <div class="space-y-3">
                <input type="text" id="searchProductID" placeholder="Cari Produk ID..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <input type="text" id="searchCode" placeholder="Kode Produk..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <input type="text" id="searchPO" placeholder="Nomor PO..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <input type="text" id="searchTambak" placeholder="Kode Tambak..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <button onclick="performSearch()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg text-sm">
                    üîç Cari Sekarang
                </button>
            </div>
        </div>

        <!-- Search Results -->
        <div class="mobile-card bg-white p-4">
            <h3 class="text-lg font-bold text-gray-900 mb-3">Hasil Pencarian</h3>
            <div id="searchResultsContent">
                <p class="text-gray-500 text-sm">Masukkan kriteria pencarian dan klik Cari untuk melihat hasil</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let inventoryData = [];
        let filteredInventoryData = [];
        const API_KEY = "AIzaSyBhiKDVDH4fle5_EqAIaA05YjpxVMEBYZM";
        const SHEET_ID = "1dgXDpt3MTdpHZyhhY7VdKC3tT_EQJaqoBBb0VFXwJco";
        const SHEET_NAME = "DETAIL";

        // Daily columns (1-31 for outbound tracking)
        const dailyColumns = Array.from({length: 31}, (_, i) => (i + 1).toString());

        // Cache for processed data
        let dataCache = {
            locations: new Set(),
            brands: new Set(),
            sizes: new Set(),
            products: new Set(),
            tambaks: new Set(),
            lastUpdate: null
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadInventoryData();
            populateDateFilter();
        });

        // Show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Populate date filter for outbound tracking
        function populateDateFilter() {
            const dateFilter = document.getElementById('dateFilter');
            const options = '<option value="">Semua Tanggal</option>' + 
                dailyColumns.map(day => `<option value="${day}">Tanggal ${day}</option>`).join('');
            if (dateFilter) dateFilter.innerHTML = options;
        }

        // Get sheet last modified info from Drive API
        async function getSheetLastModified() {
            try {
                const url = `https://www.googleapis.com/drive/v3/files/${SHEET_ID}?fields=modifiedTime,name,lastModifyingUser&key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.modifiedTime) {
                    const modifiedDate = new Date(data.modifiedTime);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - modifiedDate) / (1000 * 60));
                    
                    let timeAgo = '';
                    if (diffMinutes < 1) {
                        timeAgo = 'Baru saja';
                    } else if (diffMinutes < 60) {
                        timeAgo = `${diffMinutes} menit yang lalu`;
                    } else if (diffMinutes < 1440) {
                        const hours = Math.floor(diffMinutes / 60);
                        timeAgo = `${hours} jam yang lalu`;
                    } else {
                        const days = Math.floor(diffMinutes / 1440);
                        timeAgo = `${days} hari yang lalu`;
                    }
                    
                    const formattedDate = modifiedDate.toLocaleString('id-ID', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'Asia/Jakarta'
                    });
                    
                    document.getElementById('lastModified').innerHTML = `
                        <div class="space-y-1">
                            <div class="font-medium text-blue-600 text-xs">${formattedDate} WIB</div>
                            <div class="text-xs text-gray-500">${timeAgo}</div>
                        </div>
                    `;
                } else {
                    document.getElementById('lastModified').innerHTML = `
                        <div class="text-red-500 text-xs">
                            <div class="font-medium">Info tidak tersedia</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error getting last modified:', error);
                document.getElementById('lastModified').innerHTML = `
                    <div class="text-red-500 text-xs">
                        <div class="font-medium">Gagal memuat info</div>
                    </div>
                `;
            }
        }

        // Load inventory data from Google Sheets
        async function loadInventoryData() {
            showLoading();
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    const headers = data.values[0];
                    const rows = data.values.slice(1);
                    
                    // Process data
                    const numericFields = new Set(['SALDO', 'KG', 'QTY MASUK', 'OFFSET', 'TOTAL KELUAR', ...dailyColumns]);
                    
                    inventoryData = rows.map(row => {
                        const item = {};
                        headers.forEach((header, index) => {
                            const value = row[index] || '';
                            if (numericFields.has(header)) {
                                item[header] = value === '' ? 0 : parseFloat(value) || 0;
                            } else {
                                item[header] = value.toString().trim();
                            }
                        });
                        return item;
                    });
                    
                    // Process cache
                    processDataCache();
                    
                    // Initialize filtered data
                    filteredInventoryData = inventoryData.slice();
                    
                    // Update UI
                    updateDashboard();
                    populateFilters();
                    updateInventoryDisplay();
                    getSheetLastModified();
                    updateReports();
                    
                    // Set filter count
                    const count = inventoryData.length;
                    const filterResultCount = document.getElementById('filterResultCount');
                    if (filterResultCount) filterResultCount.textContent = count.toLocaleString();
                    
                } else {
                    throw new Error('No data found in sheet');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                const errorMsg = error.message.includes('HTTP error') 
                    ? 'Gagal mengakses Google Sheets. Periksa koneksi internet.'
                    : 'Gagal memuat data. Coba refresh halaman.';
                alert(errorMsg);
            } finally {
                hideLoading();
            }
        }

        // Process and cache data
        function processDataCache() {
            const locationSet = new Set();
            const brandSet = new Set();
            const sizeSet = new Set();
            const productSet = new Set();
            const tambakSet = new Set();
            
            inventoryData.forEach(item => {
                const rawLocation = item.RAW;
                if (rawLocation && rawLocation.length >= 4) {
                    locationSet.add(rawLocation.substring(0, 4));
                }
                
                if (item.BRAND) brandSet.add(item.BRAND);
                if (item.SIZE) sizeSet.add(item.SIZE);
                if (item.PRODUK) productSet.add(item.PRODUK);
                if (item['KODE ASAL']) tambakSet.add(item['KODE ASAL']);
            });
            
            dataCache = {
                locations: Array.from(locationSet).sort(),
                brands: Array.from(brandSet).sort(),
                sizes: Array.from(sizeSet).sort(),
                products: Array.from(productSet).sort(),
                tambaks: Array.from(tambakSet).sort(),
                lastUpdate: Date.now()
            };
        }

        // Update dashboard statistics
        function updateDashboard() {
            const totalItems = inventoryData.length;
            
            let gimItems = 0, contItems = 0, wkbItems = 0;
            let gimWeight = 0, contWeight = 0, wkbWeight = 0;
            
            inventoryData.forEach(item => {
                const location = (item.RAW || '').toUpperCase();
                const weight = item.KG || 0;
                
                if (location.includes('GIM')) {
                    gimItems++;
                    gimWeight += weight;
                } else if (location.includes('CONT')) {
                    contItems++;
                    contWeight += weight;
                } else {
                    wkbItems++;
                    wkbWeight += weight;
                }
            });

            // Update stats
            document.getElementById('totalItems').textContent = totalItems.toLocaleString();
            document.getElementById('gimLocation').textContent = gimItems.toLocaleString();
            document.getElementById('contLocation').textContent = contItems.toLocaleString();
            document.getElementById('wkbLocation').textContent = wkbItems.toLocaleString();

            // Update weights
            document.getElementById('gimTotalWeight').textContent = gimWeight.toLocaleString();
            document.getElementById('contTotalWeight').textContent = contWeight.toLocaleString();
            document.getElementById('wkbTotalWeight').textContent = wkbWeight.toLocaleString();

            // Update daily data
            const dateGroups = {};
            
            inventoryData.forEach(item => {
                const tglMsk = item['TGL MSK'];
                if (!tglMsk || tglMsk === '' || tglMsk === 'N/A' || tglMsk === '-') return;
                
                const cleanDate = tglMsk.toString().trim();
                if (cleanDate.length === 0) return;
                
                let displayDate = cleanDate;
                let parsedDate = new Date();
                
                try {
                    if (cleanDate.includes('/')) {
                        const parts = cleanDate.split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            
                            if (year > 1900 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                                parsedDate = new Date(year, month - 1, day);
                                displayDate = parsedDate.toLocaleDateString('id-ID', {
                                    weekday: 'short',
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric'
                                });
                            }
                        }
                    }
                } catch (e) {
                    displayDate = cleanDate;
                }
                
                if (!dateGroups[displayDate]) {
                    dateGroups[displayDate] = {
                        totalSaldo: 0,
                        totalKG: 0,
                        count: 0,
                        rawDate: parsedDate
                    };
                }
                dateGroups[displayDate].totalSaldo += item.SALDO || 0;
                dateGroups[displayDate].totalKG += item.KG || 0;
                dateGroups[displayDate].count += 1;
            });

            // Sort by date and show last 5
            const sortedDates = Object.entries(dateGroups)
                .sort((a, b) => new Date(b[1].rawDate) - new Date(a[1].rawDate))
                .slice(0, 5);

            const dailyDataHtml = sortedDates.length > 0 ? sortedDates.map(([displayDate, data]) => `
                <div class="p-2 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-blue-400">
                    <div class="flex items-center justify-between mb-1">
                        <p class="font-medium text-gray-900 text-sm">üìÖ ${displayDate}</p>
                        <div class="text-right">
                            <div class="text-sm font-bold text-blue-600">${data.totalSaldo.toLocaleString()}</div>
                            <div class="text-xs text-gray-500">${data.totalKG.toLocaleString()} KG</div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">${data.count} items masuk</p>
                </div>
            `).join('') : '<div class="p-2 bg-gray-50 rounded-lg text-center"><p class="text-gray-500 text-xs">üìÖ Tidak ada data masuk</p></div>';

            document.getElementById('recentActivity').innerHTML = dailyDataHtml;

            // Update warehouse locations
            const locationDailyData = {};
            inventoryData.forEach(item => {
                const date = item['TGL MSK'];
                const location = (item.RAW || '').toUpperCase();
                let locType = 'WKB';
                if (location.includes('GIM')) locType = 'GIM';
                else if (location.includes('CONT')) locType = 'CONT';
                
                if (date) {
                    if (!locationDailyData[locType]) {
                        locationDailyData[locType] = { totalSaldo: 0, totalKG: 0, count: 0 };
                    }
                    locationDailyData[locType].totalSaldo += item.SALDO || 0;
                    locationDailyData[locType].totalKG += item.KG || 0;
                    locationDailyData[locType].count += 1;
                }
            });
            
            const locationDailyHtml = Object.entries(locationDailyData).map(([location, data]) => `
                <div class="bg-gray-50 p-2 rounded text-center border">
                    <div class="font-medium text-sm">${location}</div>
                    <div class="text-xs font-bold text-blue-600">${data.totalSaldo.toLocaleString()}</div>
                    <div class="text-xs text-gray-500">${data.totalKG.toLocaleString()} KG</div>
                </div>
            `).join('');

            document.getElementById('warehouseLocations').innerHTML = locationDailyHtml || '<p class="text-gray-500 text-sm">Tidak ada data lokasi</p>';
        }

        // Populate filter dropdowns
        function populateFilters() {
            const locationFilter = document.getElementById('locationFilter');
            const brandFilter = document.getElementById('brandFilter');
            const sizeFilter = document.getElementById('sizeFilter');

            if (locationFilter) {
                locationFilter.innerHTML = '<option value="">Semua Lokasi</option>' + 
                    dataCache.locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
            }

            if (brandFilter) {
                brandFilter.innerHTML = '<option value="">Semua Brand</option>' + 
                    dataCache.brands.map(brand => `<option value="${brand}">${brand}</option>`).join('');
            }

            if (sizeFilter) {
                sizeFilter.innerHTML = '<option value="">Semua Size</option>' + 
                    dataCache.sizes.map(size => `<option value="${size}">${size}</option>`).join('');
            }
        }

        // Update inventory display
        function updateInventoryDisplay() {
            updateInventoryCards();
        }

        // Update inventory cards
        function updateInventoryCards() {
            const container = document.getElementById('inventoryCards');
            if (!container) return;
            
            const data = filteredInventoryData.length > 0 ? filteredInventoryData : inventoryData;
            
            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4 text-sm">Tidak ada data inventory</p>';
                return;
            }

            // Show first 50 items for mobile
            const mobileData = data.slice(0, 50);
            const html = mobileData.map(item => {
                const saldo = item.SALDO || 0;
                const borderClass = saldo > 0 ? 'border-green-500' : 'border-red-500';
                const badgeClass = saldo > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const productId = (item['PRODUK ID'] || '').replace(/'/g, '\\\'');
                
                return `<div class="mobile-card bg-white p-4 border-l-4 ${borderClass}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-900 text-sm">${item['PRODUK ID'] || '-'}</h4>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${badgeClass}">
                            ${saldo.toLocaleString()}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-3">
                        <div>Lokasi: ${(item.RAW || '').substring(0, 4) || '-'}</div>
                        <div>Size: ${item.SIZE || '-'}</div>
                        <div>Brand: ${item.BRAND || '-'}</div>
                        <div>Berat: ${(item.KG || 0).toLocaleString()} KG</div>
                        <div>Jenis: ${item.PRODUK || '-'}</div>
                        <div>Tambak: ${item['KODE ASAL'] || '-'}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="showItemDetailModal('${productId}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-3 rounded-lg">
                            üìã Detail
                        </button>
                        <div class="text-xs text-gray-500 flex items-center">
                            ${item['TGL MSK'] || '-'}
                        </div>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = html;
            
            // Add load more button if there are more items
            if (data.length > 50) {
                const loadMoreBtn = `
                    <div class="mobile-card bg-gray-50 p-4 text-center">
                        <p class="text-sm text-gray-600 mb-2">Menampilkan 50 dari ${data.length} items</p>
                        <button onclick="loadMoreItems()" class="bg-gray-500 hover:bg-gray-600 text-white text-sm py-2 px-4 rounded-lg">
                            üìÑ Muat Lebih Banyak
                        </button>
                    </div>
                `;
                container.innerHTML += loadMoreBtn;
            }
        }

        // Load more items
        let itemsLoaded = 50;
        function loadMoreItems() {
            const container = document.getElementById('inventoryCards');
            const data = filteredInventoryData.length > 0 ? filteredInventoryData : inventoryData;
            
            const nextBatch = data.slice(itemsLoaded, itemsLoaded + 50);
            itemsLoaded += 50;
            
            const html = nextBatch.map(item => {
                const saldo = item.SALDO || 0;
                const borderClass = saldo > 0 ? 'border-green-500' : 'border-red-500';
                const badgeClass = saldo > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const productId = (item['PRODUK ID'] || '').replace(/'/g, '\\\'');
                
                return `<div class="mobile-card bg-white p-4 border-l-4 ${borderClass}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-900 text-sm">${item['PRODUK ID'] || '-'}</h4>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${badgeClass}">
                            ${saldo.toLocaleString()}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-3">
                        <div>Lokasi: ${(item.RAW || '').substring(0, 4) || '-'}</div>
                        <div>Size: ${item.SIZE || '-'}</div>
                        <div>Brand: ${item.BRAND || '-'}</div>
                        <div>Berat: ${(item.KG || 0).toLocaleString()} KG</div>
                        <div>Jenis: ${item.PRODUK || '-'}</div>
                        <div>Tambak: ${item['KODE ASAL'] || '-'}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="showItemDetailModal('${productId}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-3 rounded-lg">
                            üìã Detail
                        </button>
                        <div class="text-xs text-gray-500 flex items-center">
                            ${item['TGL MSK'] || '-'}
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            // Remove existing load more button
            const existingBtn = container.querySelector('.bg-gray-50');
            if (existingBtn) existingBtn.remove();
            
            // Add new items
            container.innerHTML += html;
            
            // Add new load more button if needed
            if (itemsLoaded < data.length) {
                const loadMoreBtn = `
                    <div class="mobile-card bg-gray-50 p-4 text-center">
                        <p class="text-sm text-gray-600 mb-2">Menampilkan ${itemsLoaded} dari ${data.length} items</p>
                        <button onclick="loadMoreItems()" class="bg-gray-500 hover:bg-gray-600 text-white text-sm py-2 px-4 rounded-lg">
                            üìÑ Muat Lebih Banyak
                        </button>
                    </div>
                `;
                container.innerHTML += loadMoreBtn;
            }
        }

        // Update outbound table
        function updateOutboundTable(filteredDate = null, filteredProduct = null) {
            const container = document.getElementById('outboundTable');
            if (!container) return;
            
            const outboundData = [];

            // Process daily outbound data
            inventoryData.forEach(item => {
                dailyColumns.forEach(day => {
                    const qtyOut = parseFloat(item[day] || 0);
                    if (qtyOut > 0) {
                        // Apply filters
                        if (filteredDate && day !== filteredDate) return;
                        if (filteredProduct && !(item['PRODUK ID'] || '').toLowerCase().includes(filteredProduct.toLowerCase())) return;

                        outboundData.push({
                            productId: item['PRODUK ID'] || 'N/A',
                            location: (item.RAW || '').substring(0, 4),
                            brand: item.BRAND || 'N/A',
                            size: item.SIZE || 'N/A',
                            produk: item.PRODUK || 'N/A',
                            tambak: item['KODE ASAL'] || 'N/A',
                            date: day,
                            qtyOut: qtyOut,
                            saldo: item.SALDO || 0,
                            kg: item.KG || 0,
                            tglMasuk: item['TGL MSK'] || 'N/A',
                            po: item.PO || 'N/A',
                            totalKeluar: item['TOTAL KELUAR'] || item.OFFSET || 0,
                            qtyMasuk: item['QTY MASUK'] || 0
                        });
                    }
                });
            });

            // Sort by date descending and limit to 30 items
            outboundData.sort((a, b) => parseInt(b.date) - parseInt(a.date));
            const limitedData = outboundData.slice(0, 30);

            if (limitedData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Tidak ada data outbound ditemukan</p>';
                updateOutboundSummary(outboundData);
                return;
            }

            const html = limitedData.map(item => {
                const saldoClass = item.saldo > 0 ? 'text-green-600' : 'text-red-600';
                const dateClass = parseInt(item.date) <= 15 ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';
                
                return `
                <div class="mobile-card bg-white p-4 border-l-4 border-orange-500">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-gray-900 text-sm">${item.productId}</h4>
                            <p class="text-xs text-gray-500">${item.produk}</p>
                        </div>
                        <div class="text-right">
                            <span class="px-2 py-1 text-xs font-semibold ${dateClass} rounded-full">
                                Tgl ${item.date}
                            </span>
                            <div class="text-xs text-gray-500 mt-1">${item.tglMasuk}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-3">
                        <div>üìç Lokasi: <span class="font-medium">${item.location}</span></div>
                        <div>üè∑Ô∏è Brand: <span class="font-medium">${item.brand}</span></div>
                        <div>üìè Size: <span class="font-medium">${item.size}</span></div>
                        <div>üè≠ Tambak: <span class="font-medium">${item.tambak}</span></div>
                        <div>‚öñÔ∏è Berat: <span class="font-medium">${item.kg.toLocaleString()} KG</span></div>
                        <div>üìã PO: <span class="font-medium">${item.po}</span></div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-3 mb-3">
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <div class="text-xs text-gray-500">Qty Keluar</div>
                                <div class="text-sm font-bold text-red-600">${item.qtyOut.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Saldo</div>
                                <div class="text-sm font-bold ${saldoClass}">${item.saldo.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Total Keluar</div>
                                <div class="text-sm font-bold text-orange-600">${item.totalKeluar.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="showOutboundDetailModal('${item.productId}', '${item.date}')" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white text-xs py-2 px-3 rounded-lg">
                            üìã Detail Lengkap
                        </button>
                        <button onclick="showAllOutboundForProduct('${item.productId}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-3 rounded-lg">
                            üìä History
                        </button>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = html;
            
            if (outboundData.length > 30) {
                container.innerHTML += `
                    <div class="mobile-card bg-gray-50 p-4 text-center">
                        <p class="text-sm text-gray-600 mb-2">Menampilkan 30 dari ${outboundData.length} data outbound</p>
                        <button onclick="loadMoreOutbound()" class="bg-gray-500 hover:bg-gray-600 text-white text-sm py-2 px-4 rounded-lg">
                            üìÑ Muat Lebih Banyak
                        </button>
                    </div>
                `;
            }
            
            updateOutboundSummary(outboundData);
        }

        // Update outbound summary
        function updateOutboundSummary(outboundData) {
            const today = new Date().getDate();
            const todayOutbound = outboundData
                .filter(item => parseInt(item.date) === today)
                .reduce((sum, item) => sum + item.qtyOut, 0);

            const monthOutbound = outboundData.reduce((sum, item) => sum + item.qtyOut, 0);
            const activeOutbound = new Set(outboundData.map(item => item.productId)).size;

            document.getElementById('todayOutbound').textContent = todayOutbound.toLocaleString();
            document.getElementById('monthOutbound').textContent = monthOutbound.toLocaleString();
            document.getElementById('activeOutbound').textContent = activeOutbound.toLocaleString();
        }

        // Update reports
        function updateReports() {
            // Stock by Location
            const locationStats = {};
            inventoryData.forEach(item => {
                const location = (item.RAW || '').substring(0, 4);
                if (!locationStats[location]) {
                    locationStats[location] = { totalSaldo: 0, totalKG: 0, count: 0 };
                }
                locationStats[location].totalSaldo += item.SALDO || 0;
                locationStats[location].totalKG += item.KG || 0;
                locationStats[location].count += 1;
            });

            const locationHtml = Object.entries(locationStats)
                .sort((a, b) => b[1].totalSaldo - a[1].totalSaldo)
                .map(([location, data]) => `
                    <div class="p-2 bg-gray-50 rounded-lg border-l-4 border-blue-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-900 text-sm">${location || 'Unknown'}</p>
                                <p class="text-xs text-gray-600">${data.count} items</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-blue-600">${data.totalSaldo.toLocaleString()}</div>
                                <div class="text-xs text-gray-500">${data.totalKG.toLocaleString()} KG</div>
                            </div>
                        </div>
                    </div>
                `).join('');

            document.getElementById('stockByLocation').innerHTML = locationHtml || '<p class="text-gray-500 text-sm">Tidak ada data</p>';

            // Stock by Brand
            const brandStats = {};
            inventoryData.forEach(item => {
                const brand = item.BRAND || 'Unknown';
                if (!brandStats[brand]) {
                    brandStats[brand] = { totalSaldo: 0, totalKG: 0, count: 0 };
                }
                brandStats[brand].totalSaldo += item.SALDO || 0;
                brandStats[brand].totalKG += item.KG || 0;
                brandStats[brand].count += 1;
            });

            const brandHtml = Object.entries(brandStats)
                .sort((a, b) => b[1].totalSaldo - a[1].totalSaldo)
                .slice(0, 10)
                .map(([brand, data]) => `
                    <div class="p-2 bg-gray-50 rounded-lg border-l-4 border-green-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-900 text-sm">${brand}</p>
                                <p class="text-xs text-gray-600">${data.count} items</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-green-600">${data.totalSaldo.toLocaleString()}</div>
                                <div class="text-xs text-gray-500">${data.totalKG.toLocaleString()} KG</div>
                            </div>
                        </div>
                    </div>
                `).join('');

            document.getElementById('stockByBrand').innerHTML = brandHtml || '<p class="text-gray-500 text-sm">Tidak ada data</p>';

            // Size Distribution (Saldo)
            const sizeStatsSaldo = {};
            inventoryData.forEach(item => {
                const size = item.SIZE || 'Unknown';
                if (!sizeStatsSaldo[size]) {
                    sizeStatsSaldo[size] = { totalSaldo: 0, count: 0 };
                }
                sizeStatsSaldo[size].totalSaldo += item.SALDO || 0;
                sizeStatsSaldo[size].count += 1;
            });

            const sizeSaldoHtml = Object.entries(sizeStatsSaldo)
                .sort((a, b) => b[1].totalSaldo - a[1].totalSaldo)
                .slice(0, 10)
                .map(([size, data]) => `
                    <div class="p-2 bg-gray-50 rounded-lg border-l-4 border-yellow-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-900 text-sm">Size ${size}</p>
                                <p class="text-xs text-gray-600">${data.count} items</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-yellow-600">${data.totalSaldo.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

            document.getElementById('sizeDistributionSaldo').innerHTML = sizeSaldoHtml || '<p class="text-gray-500 text-sm">Tidak ada data</p>';

            // Size Distribution (KG)
            const sizeStatsKG = {};
            inventoryData.forEach(item => {
                const size = item.SIZE || 'Unknown';
                if (!sizeStatsKG[size]) {
                    sizeStatsKG[size] = { totalKG: 0, count: 0 };
                }
                sizeStatsKG[size].totalKG += item.KG || 0;
                sizeStatsKG[size].count += 1;
            });

            const sizeKGHtml = Object.entries(sizeStatsKG)
                .sort((a, b) => b[1].totalKG - a[1].totalKG)
                .slice(0, 10)
                .map(([size, data]) => `
                    <div class="p-2 bg-gray-50 rounded-lg border-l-4 border-purple-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-900 text-sm">Size ${size}</p>
                                <p class="text-xs text-gray-600">${data.count} items</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-purple-600">${data.totalKG.toLocaleString()} KG</div>
                            </div>
                        </div>
                    </div>
                `).join('');

            document.getElementById('sizeDistributionKG').innerHTML = sizeKGHtml || '<p class="text-gray-500 text-sm">Tidak ada data</p>';

            // Performance Metrics
            const totalItems = inventoryData.length;
            const totalSaldo = inventoryData.reduce((sum, item) => sum + (item.SALDO || 0), 0);
            const totalKG = inventoryData.reduce((sum, item) => sum + (item.KG || 0), 0);
            const avgSaldoPerItem = totalItems > 0 ? (totalSaldo / totalItems).toFixed(2) : 0;
            const avgKGPerItem = totalItems > 0 ? (totalKG / totalItems).toFixed(2) : 0;

            const performanceHtml = `
                <div class="space-y-2">
                    <div class="p-2 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium">Total Items:</span>
                            <span class="text-sm font-bold text-blue-600">${totalItems.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="p-2 bg-green-50 rounded-lg border-l-4 border-green-400">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium">Total Saldo:</span>
                            <span class="text-sm font-bold text-green-600">${totalSaldo.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="p-2 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium">Total KG:</span>
                            <span class="text-sm font-bold text-yellow-600">${totalKG.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="p-2 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium">Avg Saldo/Item:</span>
                            <span class="text-sm font-bold text-purple-600">${avgSaldoPerItem}</span>
                        </div>
                    </div>
                    <div class="p-2 bg-red-50 rounded-lg border-l-4 border-red-400">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium">Avg KG/Item:</span>
                            <span class="text-sm font-bold text-red-600">${avgKGPerItem}</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('performanceMetrics').innerHTML = performanceHtml;
        }

        // Apply filters
        function applyFilters() {
            const locationFilter = document.getElementById('locationFilter').value;
            const brandFilter = document.getElementById('brandFilter').value;
            const sizeFilter = document.getElementById('sizeFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            const productIdFilter = document.getElementById('productIdFilter').value.toLowerCase();

            filteredInventoryData = inventoryData.filter(item => {
                // Location filter
                if (locationFilter && !(item.RAW || '').substring(0, 4).includes(locationFilter)) {
                    return false;
                }

                // Brand filter
                if (brandFilter && item.BRAND !== brandFilter) {
                    return false;
                }

                // Size filter
                if (sizeFilter && item.SIZE !== sizeFilter) {
                    return false;
                }

                // Stock filter
                if (stockFilter) {
                    const saldo = item.SALDO || 0;
                    if (stockFilter === 'available' && saldo <= 0) return false;
                    if (stockFilter === 'empty' && saldo !== 0) return false;
                    if (stockFilter === 'low' && saldo >= 10) return false;
                }

                // Product ID filter
                if (productIdFilter && !(item['PRODUK ID'] || '').toLowerCase().includes(productIdFilter)) {
                    return false;
                }

                return true;
            });

            // Reset items loaded counter
            itemsLoaded = 50;

            // Update display
            updateInventoryDisplay();

            // Update filter count
            const count = filteredInventoryData.length;
            document.getElementById('filterResultCount').textContent = count.toLocaleString();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('locationFilter').value = '';
            document.getElementById('brandFilter').value = '';
            document.getElementById('sizeFilter').value = '';
            document.getElementById('stockFilter').value = '';
            document.getElementById('productIdFilter').value = '';

            filteredInventoryData = inventoryData.slice();
            itemsLoaded = 50;
            updateInventoryDisplay();

            const count = inventoryData.length;
            document.getElementById('filterResultCount').textContent = count.toLocaleString();
        }

        // Apply outbound filters
        function applyOutboundFilters() {
            const dateFilter = document.getElementById('dateFilter').value;
            const productFilter = document.getElementById('outboundProductFilter').value;

            updateOutboundTable(dateFilter, productFilter);
        }

        // Perform search
        function performSearch() {
            const productID = document.getElementById('searchProductID').value.toLowerCase();
            const code = document.getElementById('searchCode').value.toLowerCase();
            const po = document.getElementById('searchPO').value.toLowerCase();
            const tambak = document.getElementById('searchTambak').value.toLowerCase();

            if (!productID && !code && !po && !tambak) {
                alert('Masukkan minimal satu kriteria pencarian');
                return;
            }

            const results = inventoryData.filter(item => {
                const matchProductID = !productID || (item['PRODUK ID'] || '').toLowerCase().includes(productID);
                const matchCode = !code || (item.KODE || '').toLowerCase().includes(code);
                const matchPO = !po || (item.PO || '').toLowerCase().includes(po);
                const matchTambak = !tambak || (item['KODE ASAL'] || '').toLowerCase().includes(tambak);

                return matchProductID && matchCode && matchPO && matchTambak;
            });

            displaySearchResults(results);
        }

        // Display search results
        function displaySearchResults(results) {
            const container = document.getElementById('searchResultsContent');

            if (results.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Tidak ada hasil yang ditemukan</p>';
                return;
            }

            const html = results.slice(0, 20).map(item => {
                const saldo = item.SALDO || 0;
                const borderClass = saldo > 0 ? 'border-green-500' : 'border-red-500';
                const badgeClass = saldo > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const productId = (item['PRODUK ID'] || '').replace(/'/g, '\\\'');

                return `<div class="border border-gray-200 rounded-lg p-3 mb-2 border-l-4 ${borderClass}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-900 text-sm">${item['PRODUK ID'] || '-'}</h4>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${badgeClass}">
                            ${saldo.toLocaleString()}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-1 text-xs text-gray-600 mb-2">
                        <div>Lokasi: ${(item.RAW || '').substring(0, 4) || '-'}</div>
                        <div>Size: ${item.SIZE || '-'}</div>
                        <div>Brand: ${item.BRAND || '-'}</div>
                        <div>Berat: ${(item.KG || 0).toLocaleString()} KG</div>
                        <div>Jenis: ${item.PRODUK || '-'}</div>
                        <div>Tambak: ${item['KODE ASAL'] || '-'}</div>
                        <div>PO: ${item.PO || '-'}</div>
                        <div>Kode: ${item.KODE || '-'}</div>
                    </div>
                    <button onclick="showItemDetailModal('${productId}')" class="text-blue-600 hover:text-blue-800 font-medium text-xs">
                        üìã Detail Lengkap
                    </button>
                </div>`;
            }).join('');

            container.innerHTML = html;

            if (results.length > 20) {
                container.innerHTML += `<div class="text-center text-xs text-gray-500 mt-2">Menampilkan 20 dari ${results.length} hasil pencarian</div>`;
            }
        }

        // Show item detail modal
        function showItemDetailModal(productId) {
            const item = inventoryData.find(i => i['PRODUK ID'] === productId);
            if (!item) return;

            const modal = document.getElementById('itemDetailModal');
            const content = document.getElementById('itemDetailContent');

            const saldo = item.SALDO || 0;
            const badgeClass = saldo > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

            // Calculate daily outbound data
            const dailyOutbound = dailyColumns.map(day => ({
                day: day,
                qty: item[day] || 0
            })).filter(d => d.qty > 0);

            const dailyOutboundHtml = dailyOutbound.length > 0 ? 
                dailyOutbound.map(d => `
                    <div class="flex justify-between py-1 border-b border-gray-100">
                        <span class="text-xs">Tgl ${d.day}:</span>
                        <span class="text-xs font-bold text-red-600">${d.qty}</span>
                    </div>
                `).join('') : 
                '<p class="text-xs text-gray-500">Tidak ada data outbound</p>';

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="text-center">
                        <h3 class="text-lg font-bold text-gray-900 mb-2">${item['PRODUK ID'] || '-'}</h3>
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${badgeClass}">
                            Saldo: ${saldo.toLocaleString()}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="font-medium text-gray-600">Lokasi RAW:</span>
                            <p class="font-bold">${item.RAW || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Jenis Produk:</span>
                            <p class="font-bold">${item.PRODUK || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Size Udang:</span>
                            <p class="font-bold">${item.SIZE || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Brand:</span>
                            <p class="font-bold">${item.BRAND || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Kode Tambak:</span>
                            <p class="font-bold">${item['KODE ASAL'] || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Berat (KG):</span>
                            <p class="font-bold">${(item.KG || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Qty Masuk:</span>
                            <p class="font-bold">${(item['QTY MASUK'] || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Total Keluar:</span>
                            <p class="font-bold">${(item['TOTAL KELUAR'] || item.OFFSET || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Tgl Masuk:</span>
                            <p class="font-bold">${item['TGL MSK'] || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">PO Number:</span>
                            <p class="font-bold">${item.PO || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Kode:</span>
                            <p class="font-bold">${item.KODE || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Julian Date:</span>
                            <p class="font-bold">${item.JD || '-'}</p>
                        </div>
                    </div>
                    
                    <div class="border-t pt-3">
                        <h4 class="font-bold text-gray-900 mb-2">üì§ Daily Outbound</h4>
                        <div class="max-h-32 overflow-y-auto">
                            ${dailyOutboundHtml}
                        </div>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close item modal
        function closeItemModal() {
            document.getElementById('itemDetailModal').classList.add('hidden');
        }

        // Show outbound detail modal
        function showOutboundDetailModal(productId, date) {
            const item = inventoryData.find(i => i['PRODUK ID'] === productId);
            if (!item) return;

            const modal = document.getElementById('outboundDetailModal');
            const content = document.getElementById('outboundDetailContent');

            const qtyOut = item[date] || 0;
            const saldo = item.SALDO || 0;
            const saldoClass = saldo > 0 ? 'text-green-600' : 'text-red-600';
            const totalKeluar = item['TOTAL KELUAR'] || item.OFFSET || 0;
            const qtyMasuk = item['QTY MASUK'] || 0;

            // Calculate percentage of outbound
            const outboundPercentage = qtyMasuk > 0 ? ((totalKeluar / qtyMasuk) * 100).toFixed(1) : 0;

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="text-center bg-orange-50 rounded-lg p-4 border-l-4 border-orange-500">
                        <h3 class="text-lg font-bold text-gray-900 mb-1">${productId}</h3>
                        <p class="text-sm text-gray-600">${item.PRODUK || '-'}</p>
                        <div class="mt-2">
                            <span class="px-3 py-1 text-sm font-semibold bg-orange-100 text-orange-800 rounded-full">
                                Outbound Tanggal ${date}
                            </span>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 rounded-lg p-4 border-l-4 border-red-500">
                        <h4 class="font-bold text-red-700 mb-2">üì§ Data Keluar</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">Qty Keluar Tgl ${date}:</span>
                                <p class="font-bold text-red-600 text-lg">${qtyOut.toLocaleString()}</p>
                            </div>
                            <div>
                                <span class="text-gray-600">Total Keluar:</span>
                                <p class="font-bold text-red-600">${totalKeluar.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                        <h4 class="font-bold text-blue-700 mb-2">üìä Status Stock</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">Qty Masuk:</span>
                                <p class="font-bold text-blue-600">${qtyMasuk.toLocaleString()}</p>
                            </div>
                            <div>
                                <span class="text-gray-600">Saldo Tersisa:</span>
                                <p class="font-bold ${saldoClass}">${saldo.toLocaleString()}</p>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-600">Persentase Keluar:</span>
                                <p class="font-bold text-purple-600">${outboundPercentage}%</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-purple-600 h-2 rounded-full" style="width: ${Math.min(outboundPercentage, 100)}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="font-medium text-gray-600">Lokasi RAW:</span>
                            <p class="font-bold">${item.RAW || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Brand:</span>
                            <p class="font-bold">${item.BRAND || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Size:</span>
                            <p class="font-bold">${item.SIZE || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Berat (KG):</span>
                            <p class="font-bold">${(item.KG || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Tambak:</span>
                            <p class="font-bold">${item['KODE ASAL'] || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">PO:</span>
                            <p class="font-bold">${item.PO || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Tgl Masuk:</span>
                            <p class="font-bold">${item['TGL MSK'] || '-'}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Kode:</span>
                            <p class="font-bold">${item.KODE || '-'}</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 pt-3 border-t">
                        <button onclick="showAllOutboundForProduct('${productId}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm">
                            üìä Lihat History
                        </button>
                        <button onclick="closeOutboundModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm">
                            Tutup
                        </button>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Show all outbound for product
        function showAllOutboundForProduct(productId) {
            const item = inventoryData.find(i => i['PRODUK ID'] === productId);
            if (!item) return;

            const modal = document.getElementById('outboundHistoryModal');
            const content = document.getElementById('outboundHistoryContent');

            // Get all outbound data for this product
            const outboundHistory = [];
            dailyColumns.forEach(day => {
                const qtyOut = parseFloat(item[day] || 0);
                if (qtyOut > 0) {
                    outboundHistory.push({
                        date: day,
                        qtyOut: qtyOut
                    });
                }
            });

            // Sort by date
            outboundHistory.sort((a, b) => parseInt(a.date) - parseInt(b.date));

            const totalOutbound = outboundHistory.reduce((sum, h) => sum + h.qtyOut, 0);
            const avgDaily = outboundHistory.length > 0 ? (totalOutbound / outboundHistory.length).toFixed(1) : 0;

            const historyHtml = outboundHistory.length > 0 ? 
                outboundHistory.map(h => `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                        <span class="text-sm font-medium">Tanggal ${h.date}</span>
                        <span class="text-sm font-bold text-red-600">${h.qtyOut.toLocaleString()}</span>
                    </div>
                `).join('') : 
                '<p class="text-sm text-gray-500 text-center py-4">Tidak ada history outbound</p>';

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="text-center bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                        <h3 class="text-lg font-bold text-gray-900 mb-1">${productId}</h3>
                        <p class="text-sm text-gray-600">${item.PRODUK || '-'}</p>
                        <p class="text-xs text-gray-500 mt-1">${item.BRAND || '-'} ‚Ä¢ Size ${item.SIZE || '-'}</p>
                    </div>
                    
                    <div class="bg-orange-50 rounded-lg p-4 border-l-4 border-orange-500">
                        <h4 class="font-bold text-orange-700 mb-2">üìä Summary Outbound</h4>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <div class="text-xs text-gray-600">Total Keluar</div>
                                <div class="text-sm font-bold text-red-600">${totalOutbound.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-600">Hari Aktif</div>
                                <div class="text-sm font-bold text-blue-600">${outboundHistory.length}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-600">Rata-rata</div>
                                <div class="text-sm font-bold text-green-600">${avgDaily}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-700 mb-3">üìÖ History Detail</h4>
                        <div class="max-h-48 overflow-y-auto">
                            ${historyHtml}
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">
                        <h4 class="font-bold text-green-700 mb-2">üì¶ Info Produk</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>Saldo: <span class="font-bold">${(item.SALDO || 0).toLocaleString()}</span></div>
                            <div>Berat: <span class="font-bold">${(item.KG || 0).toLocaleString()} KG</span></div>
                            <div>Tambak: <span class="font-bold">${item['KODE ASAL'] || '-'}</span></div>
                            <div>Lokasi: <span class="font-bold">${item.RAW || '-'}</span></div>
                        </div>
                    </div>
                    
                    <button onclick="closeOutboundHistoryModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm">
                        Tutup
                    </button>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close outbound modal
        function closeOutboundModal() {
            document.getElementById('outboundDetailModal').classList.add('hidden');
        }

        // Close outbound history modal
        function closeOutboundHistoryModal() {
            document.getElementById('outboundHistoryModal').classList.add('hidden');
        }

        // Load more outbound items
        let outboundItemsLoaded = 30;
        function loadMoreOutbound() {
            // This would need to be implemented based on current filters
            // For now, just increase the limit and refresh
            outboundItemsLoaded += 30;
            updateOutboundTable();
        }

        // Show page
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });

            // Show selected page
            document.getElementById(pageName + 'Page').classList.remove('hidden');

            // Update navigation
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('mobile-' + pageName).classList.add('active');

            // Load page-specific data
            if (pageName === 'outbound') {
                updateOutboundTable();
            }
        }

        // Refresh data
        function refreshData() {
            loadInventoryData();
        }

        // Close modal when clicking outside
        document.getElementById('itemDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeItemModal();
            }
        });

        document.getElementById('outboundDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOutboundModal();
            }
        });

        document.getElementById('outboundHistoryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOutboundHistoryModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'986b943df54fdf0c',t:'MTc1OTE0OTk0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
